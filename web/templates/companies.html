{% extends "layout.html" %}

{% block title %}Companies Overview – Financial Analysis Dashboard{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">All Companies</li>
  </ol>
</nav>

<!-- Page Header / Controls -->
<div class="card mb-4 border-0 shadow-sm page-header-card">
  <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <h1 class="h3 mb-1 fw-semibold">All Companies</h1>
      <p class="text-muted mb-0">
        <span class="badge rounded-pill bg-primary-soft text-primary me-2">
          {{ total_companies }} companies analyzed
        </span>
        Explore ML-driven financial insights across all tracked companies.
      </p>
    </div>

    <!-- Search quick access -->
    <form class="d-flex align-items-center gap-2" action="/search" method="get" role="search">
      <div class="input-group input-group-sm search-box">
        <span class="input-group-text bg-white border-end-0">
          <i class="bi bi-search"></i>
        </span>
        <input
          type="text"
          class="form-control border-start-0"
          name="q"
          placeholder="Search company by name…"
          aria-label="Search company by name">
      </div>
      <a href="/companies" class="btn btn-outline-secondary btn-sm d-none d-md-inline-flex">
        Reset
      </a>
    </form>
  </div>
</div>

{% if companies %}

<!-- KPI Strip -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="kpi-card">
      <div class="kpi-label text-muted">Total Companies</div>
      <div class="kpi-value">{{ total_companies }}</div>
      <div class="kpi-sub text-muted small">In current universe</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card">
      <div class="kpi-label text-muted">Current Page</div>
      <div class="kpi-value">{{ page }} / {{ total_pages if total_pages else 1 }}</div>
      <div class="kpi-sub text-muted small">
        {{ (page - 1) * 24 + 1 }}–
        {{ [page * 24, total_companies]|min }}
        shown
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card">
      <div class="kpi-label text-muted">Page Size</div>
      <div class="kpi-value">24</div>
      <div class="kpi-sub text-muted small">Companies per page</div>
    </div>
  </div>
</div>

<!-- Company Grid -->
<div class="row g-3">
  {% for company in companies %}
  <div class="col-xl-3 col-lg-4 col-md-6">
    <div class="card h-100 border-0 shadow-sm company-card">
      <!-- Card Header -->
      <div class="company-card-header d-flex justify-content-between align-items-start">
        <div>
          <h5 class="company-name mb-0 text-truncate" title="{{ company[1] }}">
            {{ company[1] }}
          </h5>
          <span class="company-id text-muted small">ID: {{ company[0] }}</span>
        </div>
        <span class="badge rounded-pill bg-light text-muted small">
          Equity
        </span>
      </div>

      <!-- Card Body -->
      <div class="card-body pt-2 pb-3">

        <!-- Key Metrics Row -->
        <div class="row g-2 mb-2">
          <div class="col-6">
            <div class="metric-chip">
              <span class="metric-label">ROE</span>
              <span class="metric-value text-success">
                {% if company[2] %}
                  {{ "%.1f"|format(company[2]) }}%
                {% else %}
                  N/A
                {% endif %}
              </span>
            </div>
          </div>
          <div class="col-6">
            <div class="metric-chip">
              <span class="metric-label">Sales Growth</span>
              <span class="metric-value text-info">
                {% if company[3] %}
                  {{ company[3] }}
                {% else %}
                  N/A
                {% endif %}
              </span>
            </div>
          </div>
        </div>

        <!-- Profit Growth -->
        <div class="mb-2">
          <div class="metric-chip w-100">
            <span class="metric-label">Profit Growth</span>
            <span class="metric-value text-warning">
              {% if company[4] %}
                {{ company[4] }}
              {% else %}
                N/A
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Pros / Cons summary -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span class="badge bg-success-soft text-success">
            {{ company[5] }} Pros
          </span>
          <span class="badge bg-danger-soft text-danger">
            {{ company[6] }} Cons
          </span>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer bg-white border-0 pt-0 pb-3">
        <a href="/company/{{ company[0] }}" class="btn btn-primary btn-sm w-100">
          View Detailed Analysis
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Company pagination" class="mt-4">
  <ul class="pagination justify-content-center mb-0">
    {% if has_prev %}
      <li class="page-item">
        <a class="page-link" href="/companies?page={{ page - 1 }}">Previous</a>
      </li>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
      {% if p == page %}
        <li class="page-item active">
          <span class="page-link">{{ p }}</span>
        </li>
      {% elif p <= 2 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
        <li class="page-item">
          <a class="page-link" href="/companies?page={{ p }}">{{ p }}</a>
        </li>
      {% elif p == 3 or p == total_pages - 2 %}
        <li class="page-item disabled">
          <span class="page-link">…</span>
        </li>
      {% endif %}
    {% endfor %}

    {% if has_next %}
      <li class="page-item">
        <a class="page-link" href="/companies?page={{ page + 1 }}">Next</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
  <h4 class="text-muted mb-2">No companies available</h4>
  <p class="text-muted mb-3">Run the analysis pipeline to populate the dashboard with company insights.</p>
  <a href="/" class="btn btn-primary btn-sm">← Back to Home</a>
</div>
{% endif %}

<!-- Back to Home -->
<div class="text-center mt-4">
  <a href="/" class="btn btn-outline-secondary btn-sm">← Back to Home</a>
</div>

<style>
  .page-header-card {
    border-radius: 0.75rem;
  }

  .bg-primary-soft {
    background-color: rgba(13, 110, 253, 0.08);
  }

  .bg-success-soft {
    background-color: rgba(25, 135, 84, 0.08);
  }

  .bg-danger-soft {
    background-color: rgba(220, 53, 69, 0.08);
  }

  .kpi-card {
    border-radius: 0.75rem;
    padding: 0.9rem 1.1rem;
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    border: 1px solid #eef0f3;
  }

  .kpi-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .kpi-value {
    font-size: 1.3rem;
    font-weight: 600;
  }

  .kpi-sub {
    margin-top: 0.1rem;
  }

  .company-card {
    border-radius: 0.75rem;
    overflow: hidden;
    transition: transform 0.18s ease, box-shadow 0.18s ease;
  }

  .company-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
  }

  .company-card-header {
    padding: 0.85rem 0.9rem 0.35rem;
    border-bottom: 1px solid #f1f3f5;
    background: linear-gradient(90deg, #f8fafc, #f3f6fb);
  }

  .company-name {
    font-size: 0.98rem;
    max-width: 180px;
  }

  .company-id {
    font-size: 0.75rem;
  }

  .metric-chip {
    border-radius: 999px;
    padding: 0.3rem 0.65rem;
    background-color: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .metric-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #6c757d;
  }

  .metric-value {
    font-size: 0.9rem;
    font-weight: 600;
  }

  .search-box .form-control {
    box-shadow: none !important;
  }

  .search-box .input-group-text {
    border-right: 0;
  }

  .search-box .form-control {
    border-left: 0;
  }

  @media (max-width: 576px) {
    .company-card-header {
      padding: 0.75rem 0.8rem 0.3rem;
    }
  }
</style>

{% endblock %}
